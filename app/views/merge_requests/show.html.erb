<%
  # encoding: utf-8
  #--
  #   Copyright (C) 2012-2013 Gitorious AS
  #   Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies)
  #   Copyright (C) 2009 Fabio Akita <fabio.akita@gmail.com>
  #   Copyright (C) 2009 Sven Eckelmann <sven.eckelmann@gmx.de>
  #   Copyright (C) 2008 Tor Arne Vestbø <tavestbo@trolltech.com>
  #   Copyright (C) 2008 Johan Sørensen <johan@johansorensen.com>
  #
  #   This program is free software: you can redistribute it and/or modify
  #   it under the terms of the GNU Affero General Public License as published by
  #   the Free Software Foundation, either version 3 of the License, or
  #   (at your option) any later version.
  #
  #   This program is distributed in the hope that it will be useful,
  #   but WITHOUT ANY WARRANTY; without even the implied warranty of
  #   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  #   GNU Affero General Public License for more details.
  #
  #   You should have received a copy of the GNU Affero General Public License
  #   along with this program.  If not, see <http://www.gnu.org/licenses/>.
  #++
  %>
<%= partial("repositories/header_compact", {
        :repository => repository,
        :project => repository.project,
        :app => Gitorious,
        :active => :merge_requests
      }) %>
<div class="container gts-body">
  <div class="pull-right">
    <%= render(:partial => "merge_requests/show/options", :locals => { :merge_request => merge_request }) %>
  </div>
  <h3>Reviewing merge request #<%= merge_request.sequence_number %></h3>
  <h1><%= @title = merge_request.summary %></h1>
  <%= description(merge_request) %>
  <p class="gts-bordered-row">
    <%= link_to(avatar(user, :size => 24) + " #{user.login}", user_path(user)) %>
    requested a merge from <%= link_to(source_repo.slug, project_repository_path(source_repo.project, source_repo)) %>
    to <%= link_to(target_repo.slug, project_repository_path(target_repo.project, target_repo)) %>
    on <%= merge_request.created_at.strftime("%B %-dth, %Y %H:%M.") %>
    <span class="pull-right">This merge request is <strong><%= merge_request.status_string %></strong>.</span>
  </p>

  <%# TODO: Add a drop-down for merge request versions %>
  <%# nav_tabs(%w(summary commits), :class => "nav nav-tabs gts-header-nav", :active => "summary") %>

  <%= link_to("View all diffs", "#", :class => "btn btn-primary pull-right") %>
  <h2>Commits to be merged</h2>
  <table class="table table-striped">
    <% commits.each do |commit| %>
      <tr>
        <td>
          <%= link_to(commit.id[0...7], project_repository_commit_path(repository.project, repository, commit.id)) %>
        </td>
        <td><%= commit.short_message %></td>
      </tr>
    <% end %>
  </table>

  <h5 class="gts-toggler" data-toggle="collapse" data-target="#how-to-update">How to update the merge request?</h5>
  <div class="collapse" id="how-to-update">
    <p>
      To update your merge request, either <%= link_to("edit here", :action =>
                                                 :edit) %> or push your changes through git. A new version of your merge
      request will be created, up until the last commit you push. You may make as
      many updates as you like; the last one will always be displayed by default
    </p>
    <pre><%= "git push #{merge_request.target_repository.push_url}:#{merge_request.merge_branch_name}" %></pre>
  </div>

  <h5 class="gts-toggler" data-toggle="collapse" data-target="#how-to-merge">How to merge these changes?</h5>
  <div class="collapse" id="how-to-merge">
    <p>
      Pull the changes into a local branch for review, verify the changes (run
      tests etc) and then merge into master:
    </p>
    <pre># Check out a new branch for integration
git checkout -b merge-requests/<%= merge_request.sequence_number %>

# Fetch the merge request into this branch
git pull <%= merge_request.target_repository.default_clone_url %> <%= merge_request.merge_branch_name %>

# Review commits
git log --pretty=oneline --abbrev-commit <%= merge_request.target_branch %>..merge-requests/<%= merge_request.sequence_number %>

# Apply the changes to your branch:
git checkout <%= merge_request.target_branch %>
git merge merge-requests/<%= merge_request.sequence_number %>
git push origin <%= merge_request.target_branch %></pre>
  </div>
  <br>

  <h2>Discussion</h2>
  <% comments.each do |comment| %>
    <%= render(:partial => "comments/comment", :locals => { :comment => comment }) %>
  <% end %>

  <% if logged_in? %>
    <%= simple_form_for(Comment.new(:target => merge_request), {
            :as => :comment,
            :url => project_repository_merge_request_comments_path(repository.project, repository, merge_request),
            :html => { :class => "form-horizontal gts-comment-form" }
          }) do |form| -%>
      <%= render(:partial => "comments/form", :locals => { :form => form }) %>
    <% end %>
  <% else %>
    <p>
      <%= link_to t("views.sessions.login"), new_sessions_path -%> or
      <%= link_to t("views.users.create"), new_user_path -%> to post a comment
    </p>
  <% end %>
</div>
