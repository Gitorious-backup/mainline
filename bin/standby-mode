#!/usr/bin/env ruby
require(File.expand_path(File.dirname(__FILE__) + "/setup"))

Gitorious::CLI.new.run_with_gitorious_environment do
  action = ARGV[0].to_s.strip

  case action
  when 'start'
    if EnableStandbyModeCommand.new(nil, File.expand_path('public')).execute
      puts 'Standby mode activated'
    else
      puts %(You need to paste public key of your master instance user to local gitorious config file as the "master_public_key" first.)
      exit 1
    end

  when 'stop'
    File.unlink STANDBY_SYMLINK_PATH if File.exist?(STANDBY_SYMLINK_PATH)
    FileUtils.ln_s File.expand_path('data/hooks'), RepositoryRoot.expand(".hooks"), :force => true

    puts 'Standby mode deactivated'

  when 'status'
    if File.exist?(STANDBY_SYMLINK_PATH)
      puts 'Standby mode ON'
      puts 'This instance acts as a mirror'
    else
      puts 'Standby mode OFF'
      puts 'This instance acts as a master'
    end

  else
    puts "Usage: #$0 start|stop|status"
  end
end
